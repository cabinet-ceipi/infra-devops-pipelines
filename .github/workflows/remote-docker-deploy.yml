name: ğŸš€ Remote Docker Deploy (VPS via password)

on:
  workflow_call:
    inputs:
      host:
        description: "Adresse du VPS (ex: vmi123456.contabo.com)"
        required: true
        type: string
      user:
        description: "Utilisateur SSH (ex: root)"
        required: true
        type: string
      target_dir:
        description: "Dossier sur le VPS contenant le docker-compose.yml"
        required: true
        type: string
      setup:
        description: "Chemin du script de setup Ã  exÃ©cuter (optionnel, ex: ./setup.sh)"
        required: false
        type: string
        default: ""
      environment:
        description: "Environnement GitHub Ã  utiliser (ex: PROD, STAGING)"
        required: false
        type: string
        default: ""
    secrets:
      SSH_PASSWORD:
        description: "Mot de passe SSH pour se connecter au VPS"
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: ğŸ› ï¸ Installer sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: ğŸ“¡ DÃ©ploiement Docker sur le VPS
        env:
          VPS_HOST: ${{ inputs.host }}
          VPS_USER: ${{ inputs.user }}
          TARGET_DIR: ${{ inputs.target_dir }}
          SETUP: ${{ inputs.setup }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "ğŸ” VPS_HOST   = $VPS_HOST"
          echo "ğŸ” VPS_USER   = $VPS_USER"
          echo "ğŸ” TARGET_DIR = $TARGET_DIR"

          if [ -z "$VPS_HOST" ] || [ -z "$VPS_USER" ]; then
            echo "âŒ VPS_HOST ou VPS_USER est vide, arrÃªt du dÃ©ploiement."
            exit 1
          fi

          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no "$VPS_USER@$VPS_HOST" << EOF
            set -e

            echo "â¡ï¸ Dossier cible : $TARGET_DIR"
            cd "$TARGET_DIR"

            echo "ğŸ³ docker compose pull"
            docker compose pull

            echo "ğŸ›‘ docker compose down"
            docker compose down

            echo "ğŸš€ docker compose up -d"
            docker compose up -d

            # VÃ©rifie si la variable SETUP (transmise depuis GitHub Actions) est dÃ©finie
            if [ -n "$SETUP" ]; then
              echo "âš™ï¸ Variable SETUP dÃ©tectÃ©e : $SETUP"
              if [ -f "$SETUP" ]; then
                echo "â–¶ï¸ ExÃ©cution du script de setup : $SETUP"
                chmod +x "$SETUP" || true
                sh "$SETUP"
              else
                echo "âŒ Fichier de setup introuvable : $SETUP"
              fi
            else
              echo "â„¹ï¸ Aucune variable SETUP dÃ©finie, pas de script de setup exÃ©cutÃ©."
            fi
          EOF
